(()=>(t,e)=>{function s(t,e,s){if(e in t){Object.defineProperty(t,e,{value:s,enumerable:true,configurable:true,writable:true})}else{t[e]=s}return t}const{NavbarComponent:i}=e.import("custom-navbar-component");class a extends i{constructor(){super();s(this,"totalCount",void 0);s(this,"settings",void 0);this.href="https://message.bilibili.com/";this.html="消息";this.popupHtml=`\n<ul id="message-list">\n<li><a data-name="reply" target="_blank" href="https://message.bilibili.com/#/reply">回复我的</a></li>\n<li><a data-name="at" target="_blank" href="https://message.bilibili.com/#/at">@我的</a></li>\n<li><a data-name="like" target="_blank" href="https://message.bilibili.com/#/love">收到的赞</a></li>\n<li><a data-name="user_msg" target="_blank" href="https://message.bilibili.com/#/whisper">我的消息</a></li>\n<li><a data-name="sys_msg" target="_blank" href="https://message.bilibili.com/#/system">系统通知</a></li>\n</ul>\n`;this.requestedPopup=true;this.active=document.URL.startsWith("https://message.bilibili.com/");this.fetchSettings().then((t=>{if(t){this.updateCount();this.setupEvents();this.onPopup=()=>this.updateCount()}}))}get name(){return"messages"}async fetchSettings(){const t=await Ajax.getJsonWithCredentials(`https://api.vc.bilibili.com/link_setting/v1/link_setting/get?msg_notify=1&show_unfollowed_msg=1`);if(t.code!==0){return}await this.setNotifyStyle(t.data.msg_notify);this.settings={notify:t.data.msg_notify!==3,hideNotFollowedCount:t.data.show_unfollowed_msg===1,json:t.data};console.log(this.settings);return t.data.msg_notify!==3}async setupEvents(){const t=await SpinQuery.select("#message-list");const e=[...t.querySelectorAll("a[data-name]")];e.forEach((t=>{t.addEventListener("click",(()=>{const e=t.getAttribute("data-count");if(!e){return}const s=parseInt(e);t.removeAttribute("data-count");this.totalCount-=s;if(this.totalCount<0){this.totalCount=0}this.setNotifyCount(this.totalCount)}))}))}async updateCount(){const t=await Ajax.getJsonWithCredentials(`https://api.bilibili.com/x/msgfeed/unread`);const e=await Ajax.getJsonWithCredentials(`https://api.vc.bilibili.com/session_svr/v1/session_svr/single_unread`);const s=await SpinQuery.select("#message-list");const i=[...s.querySelectorAll("a[data-name]")];const a=i.map((t=>t.getAttribute("data-name")));if(t.code!==0||e.code!==0){return}t.data["user_msg"]=e.data.follow_unread||0;if(!this.settings.hideNotFollowedCount){t.data["user_msg"]+=e.data.unfollow_unread||0}this.totalCount=a.reduce(((e,s)=>e+(t.data[s]||0)),0);if(!this.totalCount){return}await this.setNotifyCount(this.totalCount);a.forEach(((e,s)=>{const a=t.data[e];if(a>0){i[s].setAttribute("data-count",a.toString())}else{i[s].removeAttribute("data-count")}}))}}return{export:{Messages:a}}})();